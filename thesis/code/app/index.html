<!DOCTYPE html>
<html lang="en">
  <head>
    <title>qviz</title>
    <link rel="stylesheet" href="css/qviz.css">
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/font-awesome/3.1.1/css/font-awesome.css">
    <link rel="stylesheet" href="http://cmap.github.io/barista/barista.main.min.css">
  </head>
  <body><!-- header view target -->
    <div class="cmap-shadow">
      <div id="header_target"></div>
    </div>

  <div style="min-height:30px"></div>
    <div class="row">
      <div class="col-lg-offset-1 col-lg-10" id="content">
        <div class="row" id="inputs">
            <!-- inputs for highlighting -->
            <div class="col-lg-6" id="textarea_input">
                <form class="form-horizontal">
                    <fieldset>

                    <!-- form title -->
                    <legend>Input Node Names to Hightlight</legend>    
                    
                    <!-- Textarea -->
                    <div class="form-group">
                      <label class="col-md-4 control-label" for="highlight">Nodes of Interest:</label>
                      <div class="col-md-4">
                        <textarea class="form-control" id="highlight" name="highlight"></textarea>
                      </div>
                    </div>

                    </fieldset>

                    <!-- Button -->
                    <div class="form-group">
                      <label class="col-md-4 control-label" for="singlebutton"></label>
                      <div class="col-md-4">
                        <button name="singlebutton" class="btn btn-info" id="submit" type="button">Submit</button>
                        <button name="singlebutton" class="btn btn-default" id="clear" type="button">Clear</button>
                      </div>
                    </div>
                </form>
            </div>
            <!-- inputs for redrawing  -->
            <div class="col-lg-6">
              <form class="form-horizontal">
                <fieldset>

                <!-- Form Name -->
                <legend>Select Graph Parameters</legend>

                <!-- Select Basic -->
                <div class="form-group">
                  <label class="col-md-4 control-label" for="poscon">Poscon Set:</label>
                  <div class="col-md-4">
                    <select id="poscon" name="poscon" class="form-control">
                      <option value="HDAC_plus_PI3K_inhibitor">HDAC inhibitors & PI3K inhibitors</option>
                      <option value="HDAC_inhibitor">HDAC inhibitors</option>
                      <option value="HDAC_plus_random">HDAC inhibitors & random</option>
                    </select>
                  </div>
                </div>


                <!-- Select Basic -->
                <div class="form-group">
                  <label class="col-md-4 control-label" for="conn_space">Connectivity Space:</label>
                  <div class="col-md-4">
                    <select id="conn_space" name="conn_space" class="form-control">
                      <option value="vcap">VCAP</option>
                      
                    </select>
                  </div>
                </div>


                <!-- Textarea -->
                <div class="form-group">
                  <label class="col-md-4 control-label" for="nodes">Nodes to Graph:</label>
                  <div class="col-md-4">
                    <textarea class="form-control" id="nodes" name="nodes"></textarea>
                  </div>
                </div>

                <div class="form-group">
                  <label class="col-md-4 control-label" for="threshold">Threshold (0 - 100):</label>  
                    <div class="col-md-4">
                      <input id="threshold" name="threshold" type="text" value="90" class="form-control input-md"> 
                    </div>
                </div>

                <!-- Button -->
                <div class="form-group">
                  <label class="col-md-4 control-label" for="redraw">Redraw</label>
                  <div class="col-md-4">
                    <button id="redraw" name="redraw" class="btn btn-primary">Redraw</button>
                  </div>
                </div>

                <!-- radio buttons   -->
                <div class="form-group">
                  <label class="col-md-4 control-label" for="radios">Cursor Type</label>
                  <div class="col-md-4">
                  <div class="radio">
                    <label for="pointer">
                      <input type="radio" name="cursor" id="pointer" value="pointer" checked="checked">
                      pointer
                    </label>
                  </div>
                  <div class="radio">
                    <label for="brush">
                      <input type="radio" name="cursor" id="brush" value="brush">
                      brush
                    </label>
                  </div>
                  </div>
                </div>

              </fieldset>
            </form>

             
              

          </div>


        <div style="min-height:30px"></div>
        <div class="row">
<!--
            <div class="col-lg-4" id="tag_cloud">

            </div>
-->
            <div class="col-lg-12 dev" id="graph"></div>

        </div>
      </div>
    </div>

    <div class="row"></div>

    <div id="footer_target"></div>
  </body>
  <script src="http://cmap.github.io/barista/barista.main.min.js"></script>
  <!--<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>-->
  <script type="text/javascript">
    // set up some functions
    function draw_graph(edge_color, node_color, nodes, edges) {
      // clear the svg and brush, if any
      $("#graph svg").remove();
      //d3.selectAll(".brush").remove();

      //console.log(edge_color);
      console.log(nodes);
      console.log(edges);
      // draw the force-directed graph
      var width = Math.max($("#graph").width(), 600);
      var height = Math.max($("#graph").height(), 600);

      var force = d3.layout.force()
        .charge(-120)
        .size([width, height]);

      var svg = d3.select("#graph").append("svg")
        .attr("width", width)
        .attr("height", height);
      
      force
          .nodes(nodes)
          .links(edges)
                .linkDistance(function(d) { return (100 - d.score + 100); }) // assume scores are rankpoints
          .start();

      var link = svg.selectAll(".link")
          .data(edges)
        .enter().append("line")
          .attr("class", "link")
              .style("stroke", function(d) { return edge_color[d.direction]; })
          .style("stroke-width", 3);

      var node = svg.selectAll(".node")
          .data(nodes)
        .enter().append("circle")
          .attr("class", "node")
              .attr("id", function(d) { return d.id; })
              .style("fill", function(d) { return node_color[d.pert_type]; })
          .attr("r", 6)
            .call(force.drag);

      node.append("title")
          .text(function(d) { return d.id; });

      // set up graph behavior when reaching equilibrium
      force.on("tick", function() {
        link.attr("x1", function(d) { return d.source.x; })
            .attr("y1", function(d) { return d.source.y; })
            .attr("x2", function(d) { return d.target.x; })
            .attr("y2", function(d) { return d.target.y; });

        node.attr("cx", function(d) { return d.x; })
            .attr("cy", function(d) { return d.y; });
      });

      // enable brushing
      var brush = svg.append("g")
        .attr("class", "brush")
        .call(d3.svg.brush()
          .x(d3.scale.identity().domain([0, width]))
          .y(d3.scale.identity().domain([0, height]))
          .on("brush", function() {
            var extent = d3.event.target.extent();
            node.classed("selected", function(d) {
              return extent[0][0] <= d.x && d.x < extent[1][0]
                  && extent[0][1] <= d.y && d.y < extent[1][1];
            });
          }));

        // hide the brush initially. user can show it by clicking radio button
        $(".brush").hide();

      
    }

    // basic header and footer views
    var CMapHeaderView = new Barista.Views.CMapHeaderView({el: $("#header_target"),title: "qviz",subtitle: "visualizing cmap query results"});
    var CMapFooterView = new Barista.Views.CMapFooterView({el: $("#footer_target")});

    // set up collection(s)
    var node_collection = new Backbone.Collection([]);
    // node_collection.url = "/get_connections/connections?poscon=HDAC_plus_PI3K_inhibitor&nodes_only=true";
    // node_collection.fetch();
    var edge_collection = new Backbone.Collection([]);
    // edge_collection.url = "/get_connections/connections?poscon=HDAC_plus_PI3K_inhibitor&edges_only=true";
    // edge_collection.fetch();

    // set up some variables for force-directed graph
    var node_color = {"trt_cp": "blue", "trt_oe": "green", "trt_sh.cgs": "red"};
    var edge_color = {"pos": "red", "neg": "blue"};


    // fetch data and draw the graph
    var collection = $("#conn_space").val();
    $.getJSON("/get_connections/" + collection + "?poscon=HDAC_plus_PI3K_inhibitor").done(function(response) {
      node_collection.reset(response.nodes);
      edge_collection.reset(response.edges);
      draw_graph(edge_color, node_color, node_collection.toJSON(), edge_collection.toJSON());
    });

    // parse input from textarea
    $("#submit").click(function(event) {
        var lines = $("#highlight").val().split("\n");
        console.log(lines);
        lines.forEach(function(entry) {
            d3.select("#" + entry)
                    .attr("class", "selected");
                    //.attr("r", 10);
        })
    })

    // clear any selections
    $("#clear").click(function(event) {
        $("#textarea").val("");
        d3.selectAll(".selected")
                .attr("class", "node");
                //.attr("r", 6);
    })

    // listen to radio buttons
    $("[name=cursor]").click(function() {
      var hide_brush = $("input:radio:checked").val() === "pointer";
      if (hide_brush) {
        $(".brush").hide();
      }
      else {
        $(".brush").show();
      }
    })

    // process input from poscon set and query space dropdown
    $("#redraw").click(function(event) {
      event.preventDefault();
      // fade out the current nodes and edges
      d3.selectAll(".node").transition().attr("r", 0).remove();
      d3.selectAll(".link").transition().style("stroke", "white").remove();
      var poscon = $("#poscon").val();
      var collection = $("#conn_space").val();
      var threshold = parseFloat($("#threshold").val());
      var nodes = [];
      $("#nodes").val().split("\n").forEach(function(node) {
        if (node !== "") nodes.push(node);
      })
      //nodes = nodes.length > 0 ? nodes : false;
      var query = $.ajax({
        url: "/get_connections/" + collection + "?poscon=" + poscon + "&thresh=" + threshold,
        type: "GET",
        dataType: "json",
        data: {"nodes": nodes}
      }).done(function(response) {
          node_collection.reset(response.nodes);
          edge_collection.reset(response.edges);
          draw_graph(edge_color, node_color, node_collection.toJSON(), edge_collection.toJSON());
        });
    })

    

    // d3.json("/get_connections/connections?poscon=HDAC_plus_PI3K_inhibitor&nodes_only=true", function(error, graph) {
    //   console.log(graph);
    

    // });

//    generating tag cloud
//      var fill = d3.scale.category20();
//
//      d3.layout.cloud().size([300, 300])
//          .words([
//            "HDAC inhibitor", "histone", "vorinostat", "panobinostat", "HDAC3", "HDAC6", "trichostatin-a","romidepsin"].map(function(d) {
//            return {text: d, size: 10 + Math.random() * 50};
//          }))
//          .rotate(function() { return ~~(Math.random() * 2) * 90; })
//          .font("Impact")
//          .fontSize(function(d) { return d.size; })
//          .on("end", draw)
//          .start();
//
//      function draw(words) {
//        d3.select("#tag_cloud").append("svg")
//            .attr("width", 300)
//            .attr("height", 300)
//          .append("g")
//            .attr("transform", "translate(150,150)")
//          .selectAll("text")
//            .data(words)
//          .enter().append("text")
//            .style("font-size", function(d) { return d.size + "px"; })
//            .style("font-family", "Impact")
//            .style("fill", function(d, i) { return fill(i); })
//            .attr("text-anchor", "middle")
//            .attr("transform", function(d) {
//              return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
//            })
//            .text(function(d) { return d.text; });
//      }

  </script>
</html>
